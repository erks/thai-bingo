<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏¥‡∏á‡πÇ‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Thai:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --p1: #4361ee; --p1-light: #818cf8; --p1-bg: #eef2ff; --p1-mark: #c7d2fe;
            --p2: #e84393; --p2-light: #f472b6; --p2-bg: #fdf2f8; --p2-mark: #fbcfe8;
            --p3: #00b894; --p3-light: #34d399; --p3-bg: #ecfdf5; --p3-mark: #a7f3d0;
            --p4: #f39c12; --p4-light: #fbbf24; --p4-bg: #fffbeb; --p4-mark: #fde68a;
        }

        body {
            font-family: 'Noto Serif Thai', serif;
            background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 40%, #c084fc 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #1e1b4b;
        }

        .screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .hidden { display: none !important; }

        /* ====== SETUP SCREEN ====== */
        .setup-container {
            background: white; border-radius: 24px; padding: 40px;
            max-width: 520px; width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); text-align: center;
        }
        .setup-container h1 {
            font-size: 2.2rem; font-weight: 900;
            background: linear-gradient(135deg, #7c3aed, #e84393);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 4px;
        }
        .subtitle { color: #6b7280; font-size: 0.95rem; margin-bottom: 28px; }
        .setup-section { margin-bottom: 22px; text-align: left; }
        .setup-section > label {
            display: block; font-weight: 700; margin-bottom: 8px; font-size: 1rem; color: #4b5563;
        }

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-group button {
            flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 12px;
            background: white; font-family: inherit; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s; min-width: 80px;
        }
        .btn-group button:hover { border-color: #a78bfa; background: #f5f3ff; }
        .btn-group button.active { border-color: #7c3aed; background: #ede9fe; color: #7c3aed; }

        .name-inputs-container { display: flex; flex-direction: column; gap: 10px; }
        .name-input-row { display: flex; align-items: center; gap: 10px; }
        .name-input-row .color-dot { width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0; }
        .name-input-row input {
            flex: 1; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-family: inherit; font-size: 1rem; outline: none; transition: border-color 0.2s;
        }
        .name-input-row input:focus { border-color: #7c3aed; }

        .start-button {
            width: 100%; padding: 14px; border: none; border-radius: 14px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white; font-family: inherit; font-size: 1.2rem; font-weight: 700;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(124,58,237,0.4); margin-top: 10px;
        }
        .start-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124,58,237,0.5); }
        .start-button:active { transform: translateY(0); }

        .hint-toggle { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .hint-toggle input { width: 18px; height: 18px; accent-color: #7c3aed; cursor: pointer; }
        .hint-toggle label { font-size: 0.9rem; color: #6b7280; cursor: pointer; }

        /* ====== GAME SCREEN ====== */
        #game-screen { flex-direction: column; align-items: center; padding: 16px; gap: 16px; }

        /* ====== CALLER SECTION ====== */
        .caller-section {
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            max-width: 900px; width: 100%;
        }

        /* Caller display row */
        .caller-row {
            display: flex; align-items: center; justify-content: center; gap: 16px;
            flex-wrap: wrap; margin-bottom: 14px;
        }

        .caller-current {
            width: 90px; height: 90px; border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(124,58,237,0.3);
            flex-shrink: 0;
        }
        .caller-current span {
            font-size: 2rem; font-weight: 800; color: white; transition: all 0.3s;
        }
        .caller-current.pop span { animation: popIn 0.4s ease-out; }
        .caller-current.has-char { background: linear-gradient(135deg, #059669, #34d399); box-shadow: 0 4px 20px rgba(5,150,105,0.3); }

        @keyframes popIn {
            0% { transform: scale(0.3); opacity: 0; }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .caller-info-col {
            display: flex; flex-direction: column; gap: 4px; align-items: center;
        }
        .caller-info { font-size: 0.85rem; color: #9ca3af; font-weight: 600; }

        /* Voice panel */
        .voice-panel { display: flex; flex-direction: column; align-items: center; gap: 12px; }

        .randomize-button {
            width: 72px; height: 72px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white; font-size: 2rem; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 15px rgba(124,58,237,0.35);
            display: flex; align-items: center; justify-content: center;
        }
        .randomize-button:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(124,58,237,0.45); }
        .randomize-button:active { transform: scale(0.97); }
        .randomize-button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .replay-button {
            padding: 10px 20px; border: none; border-radius: 12px;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white; font-family: inherit; font-size: 0.95rem; font-weight: 700;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(245,158,11,0.3);
            animation: popIn 0.3s ease-out;
        }
        .replay-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(245,158,11,0.4); }
        .replay-button:active { transform: translateY(0); }

        .reveal-button {
            padding: 10px 28px; border: none; border-radius: 12px;
            background: linear-gradient(135deg, #059669, #34d399);
            color: white; font-family: inherit; font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(5,150,105,0.3);
            animation: popIn 0.3s ease-out;
        }
        .reveal-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(5,150,105,0.4); }
        .reveal-button:active { transform: translateY(0); }

        .voice-status {
            font-size: 0.9rem; font-weight: 600; min-height: 1.4em; text-align: center;
            color: #6b7280; transition: color 0.2s;
        }
        .voice-status.error { color: #ef4444; }
        .voice-status.success { color: #059669; }

        /* Called history */
        .called-history-section { border-top: 1px solid #f3f4f6; padding-top: 10px; }
        .called-history {
            display: flex; flex-wrap: wrap; gap: 6px;
            max-height: 80px; overflow-y: auto;
        }
        .called-chip {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 3px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;
            background: #f3f4f6; color: #6b7280; animation: chipIn 0.3s ease-out;
        }
        .called-chip.consonant { background: #ede9fe; color: #6d28d9; }
        .called-chip.vowel { background: #fce7f3; color: #be185d; }
        @keyframes chipIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ====== BOARDS ====== */
        .boards-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 16px;
            max-width: 1200px; width: 100%;
        }
        .board-card {
            background: white; border-radius: 16px; padding: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1); flex: 0 1 auto; min-width: 260px;
        }
        .players-2 .board-card { width: calc(50% - 8px); max-width: 380px; }
        .players-3 .board-card { width: calc(33.33% - 12px); max-width: 320px; }
        .players-4 .board-card { width: calc(50% - 8px); max-width: 320px; }

        .board-header {
            text-align: center; padding: 8px; border-radius: 10px; margin-bottom: 10px;
            font-weight: 700; font-size: 1rem; color: white;
        }
        .board-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }

        .cell {
            aspect-ratio: 1; border-radius: 8px; border: 2px solid #e5e7eb;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.15rem; font-weight: 700; cursor: pointer;
            transition: all 0.15s; position: relative; background: white;
            user-select: none; -webkit-user-select: none; line-height: 1.1;
        }
        .cell:hover:not(.marked):not(.free) { transform: scale(1.05); border-color: #a78bfa; }
        .cell.free {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-color: #f59e0b; cursor: default; font-size: 1.3rem;
        }
        .cell.marked { border-color: transparent; transform: scale(1); cursor: default; }
        .cell.marked::after {
            content: ''; position: absolute; inset: 3px; border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.6); pointer-events: none;
        }
        .cell.mark-anim { animation: markPop 0.35s ease-out; }
        @keyframes markPop { 0% { transform: scale(1); } 40% { transform: scale(1.15); } 100% { transform: scale(1); } }

        .cell.hint-pulse { animation: hintPulse 1.5s ease-in-out infinite; }
        @keyframes hintPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(124,58,237,0); }
            50% { box-shadow: 0 0 0 5px rgba(124,58,237,0.25); }
        }
        .cell.win-glow { animation: winGlow 0.8s ease-in-out infinite alternate; z-index: 2; }
        @keyframes winGlow {
            0% { box-shadow: 0 0 8px 2px rgba(250,204,21,0.4); }
            100% { box-shadow: 0 0 16px 6px rgba(250,204,21,0.8); }
        }
        .cell.selected {
            border-color: #a78bfa; background: #ede9fe;
            box-shadow: 0 0 0 2px rgba(124,58,237,0.3);
        }
        .cell.wrong { animation: shake 0.3s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* Player-specific colors */
        .p0 .board-header { background: linear-gradient(135deg, var(--p1), var(--p1-light)); }
        .p0 .cell.marked { background: var(--p1-mark); color: var(--p1); border-color: var(--p1-light); }
        .p1 .board-header { background: linear-gradient(135deg, var(--p2), var(--p2-light)); }
        .p1 .cell.marked { background: var(--p2-mark); color: var(--p2); border-color: var(--p2-light); }
        .p2 .board-header { background: linear-gradient(135deg, var(--p3), var(--p3-light)); }
        .p2 .cell.marked { background: var(--p3-mark); color: var(--p3); border-color: var(--p3-light); }
        .p3 .board-header { background: linear-gradient(135deg, var(--p4), var(--p4-light)); }
        .p3 .cell.marked { background: var(--p4-mark); color: var(--p4); border-color: var(--p4-light); }

        /* ====== BOTTOM CONTROLS ====== */
        .bottom-controls { display: flex; gap: 12px; }
        .ctrl-btn {
            padding: 10px 24px; border: 2px solid rgba(255,255,255,0.4); border-radius: 12px;
            background: rgba(255,255,255,0.15); color: white;
            font-family: inherit; font-size: 0.95rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s; backdrop-filter: blur(4px);
        }
        .ctrl-btn:hover { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.6); }

        /* ====== WIN OVERLAY ====== */
        .win-overlay {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
        }
        .win-overlay canvas { position: absolute; inset: 0; pointer-events: none; }
        .win-content {
            background: white; border-radius: 24px; padding: 40px 50px;
            text-align: center; z-index: 1001;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popIn 0.5s ease-out;
        }
        .win-content h2 {
            font-size: 2.2rem; font-weight: 900;
            background: linear-gradient(135deg, #f59e0b, #ef4444, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .win-content .winner-name { font-size: 1.5rem; font-weight: 700; margin: 12px 0 24px; color: #4b5563; }
        .win-buttons { display: flex; gap: 12px; justify-content: center; }
        .win-buttons button {
            padding: 12px 28px; border: none; border-radius: 12px;
            font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.15s;
        }
        .win-buttons button:first-child {
            background: linear-gradient(135deg, #7c3aed, #a855f7); color: white;
            box-shadow: 0 4px 12px rgba(124,58,237,0.3);
        }
        .win-buttons button:last-child { background: #f3f4f6; color: #4b5563; }
        .win-buttons button:hover { transform: translateY(-2px); }

        /* ====== RESPONSIVE ====== */
        @media (max-width: 900px) {
            .players-3 .board-card { width: calc(50% - 8px); }
            .cell { font-size: 1rem; }
        }
        @media (max-width: 600px) {
            .setup-container { padding: 24px; }
            .setup-container h1 { font-size: 1.6rem; }
            .board-card { min-width: 220px; }
            .players-2 .board-card, .players-3 .board-card, .players-4 .board-card { width: 100%; max-width: 360px; }
            .cell { font-size: 0.9rem; border-radius: 6px; }
            .caller-current { width: 72px; height: 72px; }
            .caller-current span { font-size: 1.6rem; }
            .randomize-button { width: 60px; height: 60px; font-size: 1.6rem; }
        }
    </style>
</head>
<body>

<!-- ====== SETUP SCREEN ====== -->
<div id="setup-screen" class="screen">
    <div class="setup-container">
        <h1>üéØ ‡∏ö‡∏¥‡∏á‡πÇ‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</h1>
        <p class="subtitle">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢‡πÅ‡∏™‡∏ô‡∏™‡∏ô‡∏∏‡∏Å!</p>

        <div class="setup-section">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
            <div class="btn-group" id="player-count-btns"></div>
        </div>

        <div class="setup-section">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
            <div class="name-inputs-container" id="name-inputs"></div>
        </div>

        <div class="setup-section">
            <label>‡πÇ‡∏´‡∏°‡∏î</label>
            <div class="btn-group" id="mode-btns"></div>
        </div>

        <div class="hint-toggle">
            <input type="checkbox" id="hints-check" checked>
            <label for="hints-check">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ (‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏à‡∏∞‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)</label>
        </div>

        <button class="start-button" onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°! üéÆ</button>
    </div>
</div>

<!-- ====== GAME SCREEN ====== -->
<div id="game-screen" class="screen hidden">
    <div class="caller-section">
        <div class="caller-row">
            <!-- Calling controls -->
            <div class="voice-panel">
                <button class="randomize-button" id="random-btn" onclick="randomizeChar()">üé≤</button>
                <div style="display:flex; gap:8px;">
                    <button class="replay-button hidden" id="replay-btn" onclick="replayChar()">üîä ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                    <button class="reveal-button hidden" id="reveal-btn" onclick="revealChar()">‡πÄ‡∏â‡∏•‡∏¢</button>
                </div>
                <div class="voice-status" id="voice-status">‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
            </div>

            <!-- Current character display -->
            <div class="caller-current" id="caller-display">
                <span id="current-char">?</span>
            </div>

            <!-- Info column -->
            <div class="caller-info-col">
                <div class="caller-info"><span id="draw-count">0</span> / <span id="total-count">0</span></div>
            </div>
        </div>

        <div class="called-history-section">
            <div class="called-history" id="called-history"></div>
        </div>
    </div>

    <div id="boards-container" class="boards-container"></div>

    <div class="bottom-controls">
        <button class="ctrl-btn" onclick="backToSetup()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="ctrl-btn" onclick="resetGame()">üîÑ ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    </div>
</div>

<!-- ====== WIN OVERLAY ====== -->
<div id="win-overlay" class="win-overlay hidden">
    <canvas id="confetti-canvas"></canvas>
    <div class="win-content">
        <h2>üéâ ‡∏ö‡∏¥‡∏á‡πÇ‡∏Å! üéâ</h2>
        <p class="winner-name" id="winner-name"></p>
        <div class="win-buttons">
            <button onclick="continueAfterWin()">‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠</button>
            <button onclick="resetGame()">‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const CONSONANTS = [
    '‡∏Å','‡∏Ç','‡∏É','‡∏Ñ','‡∏Ö','‡∏Ü','‡∏á','‡∏à','‡∏â','‡∏ä','‡∏ã','‡∏å','‡∏ç','‡∏é','‡∏è',
    '‡∏ê','‡∏ë','‡∏í','‡∏ì','‡∏î','‡∏ï','‡∏ñ','‡∏ó','‡∏ò','‡∏ô','‡∏ö','‡∏õ','‡∏ú','‡∏ù','‡∏û',
    '‡∏ü','‡∏†','‡∏°','‡∏¢','‡∏£','‡∏•','‡∏ß','‡∏®','‡∏©','‡∏™','‡∏´','‡∏¨','‡∏≠','‡∏Æ'
];

const VOWELS = [
    '-‡∏∞', '-‡∏≤', '-‡∏¥', '-‡∏µ', '-‡∏∂', '-‡∏∑', '-‡∏∏', '-‡∏π',
    '‡πÄ-', '‡πÄ-‡∏∞', '‡πÅ-', '‡πÅ-‡∏∞', '‡πÇ-', '‡πÇ-‡∏∞',
    '‡πÄ-‡∏≤‡∏∞', '-‡∏≠', '‡πÄ-‡∏≠', '‡πÄ-‡∏µ‡∏¢', '‡πÄ-‡∏∑‡∏≠', '-‡∏±‡∏ß',
    '‡πÉ-', '‡πÑ-', '-‡∏≥', '‡πÄ-‡∏≤'
];

// ============================================================
// SPEECH-TO-CHARACTER MAPPING
// Each entry: [character, [...spoken forms]]
// ============================================================
const CONSONANT_SPEECH = [
    ['‡∏Å', ['‡∏Å‡∏≠‡πÑ‡∏Å‡πà','‡∏Å‡∏≠ ‡πÑ‡∏Å‡πà','‡∏Å ‡πÑ‡∏Å‡πà','‡πÑ‡∏Å‡πà','‡∏Å‡∏≠']],
    ['‡∏Ç', ['‡∏Ç‡∏≠‡πÑ‡∏Ç‡πà','‡∏Ç‡∏≠ ‡πÑ‡∏Ç‡πà','‡∏Ç ‡πÑ‡∏Ç‡πà','‡πÑ‡∏Ç‡πà','‡∏Ç‡∏≠']],
    ['‡∏É', ['‡∏Ç‡∏≠‡∏Ç‡∏ß‡∏î','‡∏Ç‡∏≠ ‡∏Ç‡∏ß‡∏î','‡∏É ‡∏Ç‡∏ß‡∏î','‡∏Ç‡∏ß‡∏î']],
    ['‡∏Ñ', ['‡∏Ñ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏¢','‡∏Ñ‡∏≠ ‡∏Ñ‡∏ß‡∏≤‡∏¢','‡∏Ñ ‡∏Ñ‡∏ß‡∏≤‡∏¢','‡∏Ñ‡∏ß‡∏≤‡∏¢','‡∏Ñ‡∏≠']],
    ['‡∏Ö', ['‡∏Ñ‡∏≠‡∏Ñ‡∏ô','‡∏Ñ‡∏≠ ‡∏Ñ‡∏ô','‡∏Ö ‡∏Ñ‡∏ô']],
    ['‡∏Ü', ['‡∏Ñ‡∏≠‡∏£‡∏∞‡∏Ü‡∏±‡∏á','‡∏Ñ‡∏≠ ‡∏£‡∏∞‡∏Ü‡∏±‡∏á','‡∏Ü ‡∏£‡∏∞‡∏Ü‡∏±‡∏á','‡∏£‡∏∞‡∏Ü‡∏±‡∏á']],
    ['‡∏á', ['‡∏á‡∏≠‡∏á‡∏π','‡∏á‡∏≠ ‡∏á‡∏π','‡∏á ‡∏á‡∏π','‡∏á‡∏π','‡∏á‡∏≠']],
    ['‡∏à', ['‡∏à‡∏≠‡∏à‡∏≤‡∏ô','‡∏à‡∏≠ ‡∏à‡∏≤‡∏ô','‡∏à ‡∏à‡∏≤‡∏ô','‡∏à‡∏≤‡∏ô','‡∏à‡∏≠']],
    ['‡∏â', ['‡∏â‡∏≠‡∏â‡∏¥‡πà‡∏á','‡∏â‡∏≠ ‡∏â‡∏¥‡πà‡∏á','‡∏â ‡∏â‡∏¥‡πà‡∏á','‡∏â‡∏¥‡πà‡∏á','‡∏â‡∏≠']],
    ['‡∏ä', ['‡∏ä‡∏≠‡∏ä‡πâ‡∏≤‡∏á','‡∏ä‡∏≠ ‡∏ä‡πâ‡∏≤‡∏á','‡∏ä ‡∏ä‡πâ‡∏≤‡∏á','‡∏ä‡πâ‡∏≤‡∏á','‡∏ä‡∏≠']],
    ['‡∏ã', ['‡∏ã‡∏≠‡πÇ‡∏ã‡πà','‡∏ã‡∏≠ ‡πÇ‡∏ã‡πà','‡∏ã ‡πÇ‡∏ã‡πà','‡πÇ‡∏ã‡πà','‡∏ã‡∏≠']],
    ['‡∏å', ['‡∏å‡∏≠‡πÄ‡∏å‡∏≠','‡∏å‡∏≠ ‡πÄ‡∏å‡∏≠','‡πÄ‡∏å‡∏≠']],
    ['‡∏ç', ['‡∏¢‡∏≠‡∏´‡∏ç‡∏¥‡∏á','‡∏¢‡∏≠ ‡∏´‡∏ç‡∏¥‡∏á','‡∏ç ‡∏´‡∏ç‡∏¥‡∏á','‡∏´‡∏ç‡∏¥‡∏á']],
    ['‡∏é', ['‡∏î‡∏≠‡∏ä‡∏é‡∏≤','‡∏î‡∏≠ ‡∏ä‡∏é‡∏≤','‡∏é ‡∏ä‡∏é‡∏≤','‡∏ä‡∏é‡∏≤']],
    ['‡∏è', ['‡∏ï‡∏≠‡∏õ‡∏è‡∏±‡∏Å','‡∏ï‡∏≠ ‡∏õ‡∏è‡∏±‡∏Å','‡∏è ‡∏õ‡∏è‡∏±‡∏Å','‡∏õ‡∏è‡∏±‡∏Å']],
    ['‡∏ê', ['‡∏ê‡∏≠‡∏ê‡∏≤‡∏ô','‡∏ê‡∏≠ ‡∏ê‡∏≤‡∏ô','‡∏ê ‡∏ê‡∏≤‡∏ô','‡∏ê‡∏≤‡∏ô']],
    ['‡∏ë', ['‡∏ó‡∏≠‡∏°‡∏ì‡πÇ‡∏ë','‡∏ó‡∏≠ ‡∏°‡∏ì‡πÇ‡∏ë','‡∏ë ‡∏°‡∏ì‡πÇ‡∏ë','‡∏°‡∏ì‡πÇ‡∏ë']],
    ['‡∏í', ['‡∏ó‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏í‡πà‡∏≤','‡∏ó‡∏≠ ‡∏ú‡∏π‡πâ‡πÄ‡∏í‡πà‡∏≤','‡∏ú‡∏π‡πâ‡πÄ‡∏í‡πà‡∏≤']],
    ['‡∏ì', ['‡∏ô‡∏≠‡πÄ‡∏ì‡∏£','‡∏ô‡∏≠ ‡πÄ‡∏ì‡∏£','‡∏ì ‡πÄ‡∏ì‡∏£','‡πÄ‡∏ì‡∏£']],
    ['‡∏î', ['‡∏î‡∏≠‡πÄ‡∏î‡πá‡∏Å','‡∏î‡∏≠ ‡πÄ‡∏î‡πá‡∏Å','‡∏î ‡πÄ‡∏î‡πá‡∏Å','‡πÄ‡∏î‡πá‡∏Å','‡∏î‡∏≠']],
    ['‡∏ï', ['‡∏ï‡∏≠‡πÄ‡∏ï‡πà‡∏≤','‡∏ï‡∏≠ ‡πÄ‡∏ï‡πà‡∏≤','‡∏ï ‡πÄ‡∏ï‡πà‡∏≤','‡πÄ‡∏ï‡πà‡∏≤','‡∏ï‡∏≠']],
    ['‡∏ñ', ['‡∏ñ‡∏≠‡∏ñ‡∏∏‡∏á','‡∏ñ‡∏≠ ‡∏ñ‡∏∏‡∏á','‡∏ñ ‡∏ñ‡∏∏‡∏á','‡∏ñ‡∏∏‡∏á','‡∏ñ‡∏≠']],
    ['‡∏ó', ['‡∏ó‡∏≠‡∏ó‡∏´‡∏≤‡∏£','‡∏ó‡∏≠ ‡∏ó‡∏´‡∏≤‡∏£','‡∏ó ‡∏ó‡∏´‡∏≤‡∏£','‡∏ó‡∏´‡∏≤‡∏£','‡∏ó‡∏≠']],
    ['‡∏ò', ['‡∏ó‡∏≠‡∏ò‡∏á','‡∏ó‡∏≠ ‡∏ò‡∏á','‡∏ò ‡∏ò‡∏á','‡∏ò‡∏á']],
    ['‡∏ô', ['‡∏ô‡∏≠‡∏´‡∏ô‡∏π','‡∏ô‡∏≠ ‡∏´‡∏ô‡∏π','‡∏ô ‡∏´‡∏ô‡∏π','‡∏´‡∏ô‡∏π','‡∏ô‡∏≠']],
    ['‡∏ö', ['‡∏ö‡∏≠‡πÉ‡∏ö‡πÑ‡∏°‡πâ','‡∏ö‡∏≠ ‡πÉ‡∏ö‡πÑ‡∏°‡πâ','‡∏ö ‡πÉ‡∏ö‡πÑ‡∏°‡πâ','‡πÉ‡∏ö‡πÑ‡∏°‡πâ','‡∏ö‡∏≠']],
    ['‡∏õ', ['‡∏õ‡∏≠‡∏õ‡∏•‡∏≤','‡∏õ‡∏≠ ‡∏õ‡∏•‡∏≤','‡∏õ ‡∏õ‡∏•‡∏≤','‡∏õ‡∏•‡∏≤','‡∏õ‡∏≠']],
    ['‡∏ú', ['‡∏ú‡∏≠‡∏ú‡∏∂‡πâ‡∏á','‡∏ú‡∏≠ ‡∏ú‡∏∂‡πâ‡∏á','‡∏ú ‡∏ú‡∏∂‡πâ‡∏á','‡∏ú‡∏∂‡πâ‡∏á','‡∏ú‡∏≠']],
    ['‡∏ù', ['‡∏ù‡∏≠‡∏ù‡∏≤','‡∏ù‡∏≠ ‡∏ù‡∏≤','‡∏ù ‡∏ù‡∏≤','‡∏ù‡∏≤','‡∏ù‡∏≠']],
    ['‡∏û', ['‡∏û‡∏≠‡∏û‡∏≤‡∏ô','‡∏û‡∏≠ ‡∏û‡∏≤‡∏ô','‡∏û ‡∏û‡∏≤‡∏ô','‡∏û‡∏≤‡∏ô','‡∏û‡∏≠']],
    ['‡∏ü', ['‡∏ü‡∏≠‡∏ü‡∏±‡∏ô','‡∏ü‡∏≠ ‡∏ü‡∏±‡∏ô','‡∏ü ‡∏ü‡∏±‡∏ô','‡∏ü‡∏±‡∏ô','‡∏ü‡∏≠']],
    ['‡∏†', ['‡∏û‡∏≠‡∏™‡∏≥‡πÄ‡∏†‡∏≤','‡∏û‡∏≠ ‡∏™‡∏≥‡πÄ‡∏†‡∏≤','‡∏† ‡∏™‡∏≥‡πÄ‡∏†‡∏≤','‡∏™‡∏≥‡πÄ‡∏†‡∏≤']],
    ['‡∏°', ['‡∏°‡∏≠‡∏°‡πâ‡∏≤','‡∏°‡∏≠ ‡∏°‡πâ‡∏≤','‡∏° ‡∏°‡πâ‡∏≤','‡∏°‡πâ‡∏≤','‡∏°‡∏≠']],
    ['‡∏¢', ['‡∏¢‡∏≠‡∏¢‡∏±‡∏Å‡∏©‡πå','‡∏¢‡∏≠ ‡∏¢‡∏±‡∏Å‡∏©‡πå','‡∏¢ ‡∏¢‡∏±‡∏Å‡∏©‡πå','‡∏¢‡∏±‡∏Å‡∏©‡πå','‡∏¢‡∏≠']],
    ['‡∏£', ['‡∏£‡∏≠‡πÄ‡∏£‡∏∑‡∏≠','‡∏£‡∏≠ ‡πÄ‡∏£‡∏∑‡∏≠','‡∏£ ‡πÄ‡∏£‡∏∑‡∏≠','‡πÄ‡∏£‡∏∑‡∏≠','‡∏£‡∏≠']],
    ['‡∏•', ['‡∏•‡∏≠‡∏•‡∏¥‡∏á','‡∏•‡∏≠ ‡∏•‡∏¥‡∏á','‡∏• ‡∏•‡∏¥‡∏á','‡∏•‡∏¥‡∏á','‡∏•‡∏≠']],
    ['‡∏ß', ['‡∏ß‡∏≠‡πÅ‡∏´‡∏ß‡∏ô','‡∏ß‡∏≠ ‡πÅ‡∏´‡∏ß‡∏ô','‡∏ß ‡πÅ‡∏´‡∏ß‡∏ô','‡πÅ‡∏´‡∏ß‡∏ô','‡∏ß‡∏≠']],
    ['‡∏®', ['‡∏®‡∏≠‡∏®‡∏≤‡∏•‡∏≤','‡∏®‡∏≠ ‡∏®‡∏≤‡∏•‡∏≤','‡∏® ‡∏®‡∏≤‡∏•‡∏≤','‡∏®‡∏≤‡∏•‡∏≤']],
    ['‡∏©', ['‡∏©‡∏≠‡∏§‡πÖ‡∏©‡∏µ','‡∏©‡∏≠ ‡∏§‡πÖ‡∏©‡∏µ','‡∏© ‡∏§‡πÖ‡∏©‡∏µ','‡∏§‡πÖ‡∏©‡∏µ']],
    ['‡∏™', ['‡∏™‡∏≠‡πÄ‡∏™‡∏∑‡∏≠','‡∏™‡∏≠ ‡πÄ‡∏™‡∏∑‡∏≠','‡∏™ ‡πÄ‡∏™‡∏∑‡∏≠','‡πÄ‡∏™‡∏∑‡∏≠','‡∏™‡∏≠']],
    ['‡∏´', ['‡∏´‡∏≠‡∏´‡∏µ‡∏ö','‡∏´‡∏≠ ‡∏´‡∏µ‡∏ö','‡∏´ ‡∏´‡∏µ‡∏ö','‡∏´‡∏µ‡∏ö','‡∏´‡∏≠']],
    ['‡∏¨', ['‡∏•‡∏≠‡∏à‡∏∏‡∏¨‡∏≤','‡∏•‡∏≠ ‡∏à‡∏∏‡∏¨‡∏≤','‡∏¨ ‡∏à‡∏∏‡∏¨‡∏≤','‡∏à‡∏∏‡∏¨‡∏≤']],
    ['‡∏≠', ['‡∏≠‡∏≠‡∏≠‡πà‡∏≤‡∏á','‡∏≠‡∏≠ ‡∏≠‡πà‡∏≤‡∏á','‡∏≠ ‡∏≠‡πà‡∏≤‡∏á','‡∏≠‡πà‡∏≤‡∏á','‡∏≠‡∏≠']],
    ['‡∏Æ', ['‡∏Æ‡∏≠‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å','‡∏Æ‡∏≠ ‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å','‡∏Æ ‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å','‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å','‡∏Æ‡∏≠']],
];

const VOWEL_SPEECH = [
    ['-‡∏∞',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏∞','‡∏™‡∏£‡∏∞ ‡∏≠‡∏∞','‡∏≠‡∏∞']],
    ['-‡∏≤',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏≤','‡∏™‡∏£‡∏∞ ‡∏≠‡∏≤','‡∏≠‡∏≤']],
    ['-‡∏¥',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏¥','‡∏™‡∏£‡∏∞ ‡∏≠‡∏¥','‡∏≠‡∏¥']],
    ['-‡∏µ',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏µ','‡∏™‡∏£‡∏∞ ‡∏≠‡∏µ','‡∏≠‡∏µ']],
    ['-‡∏∂',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏∂','‡∏™‡∏£‡∏∞ ‡∏≠‡∏∂','‡∏≠‡∏∂']],
    ['-‡∏∑',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏∑‡∏≠','‡∏™‡∏£‡∏∞ ‡∏≠‡∏∑‡∏≠','‡∏≠‡∏∑‡∏≠']],
    ['-‡∏∏',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏∏','‡∏™‡∏£‡∏∞ ‡∏≠‡∏∏','‡∏≠‡∏∏']],
    ['-‡∏π',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏π','‡∏™‡∏£‡∏∞ ‡∏≠‡∏π','‡∏≠‡∏π']],
    ['‡πÄ-',   ['‡∏™‡∏£‡∏∞‡πÄ‡∏≠','‡∏™‡∏£‡∏∞ ‡πÄ‡∏≠','‡πÄ‡∏≠']],
    ['‡πÄ-‡∏∞',  ['‡∏™‡∏£‡∏∞‡πÄ‡∏≠‡∏∞','‡∏™‡∏£‡∏∞ ‡πÄ‡∏≠‡∏∞','‡πÄ‡∏≠‡∏∞']],
    ['‡πÅ-',   ['‡∏™‡∏£‡∏∞‡πÅ‡∏≠','‡∏™‡∏£‡∏∞ ‡πÅ‡∏≠','‡πÅ‡∏≠']],
    ['‡πÅ-‡∏∞',  ['‡∏™‡∏£‡∏∞‡πÅ‡∏≠‡∏∞','‡∏™‡∏£‡∏∞ ‡πÅ‡∏≠‡∏∞','‡πÅ‡∏≠‡∏∞']],
    ['‡πÇ-',   ['‡∏™‡∏£‡∏∞‡πÇ‡∏≠','‡∏™‡∏£‡∏∞ ‡πÇ‡∏≠','‡πÇ‡∏≠']],
    ['‡πÇ-‡∏∞',  ['‡∏™‡∏£‡∏∞‡πÇ‡∏≠‡∏∞','‡∏™‡∏£‡∏∞ ‡πÇ‡∏≠‡∏∞','‡πÇ‡∏≠‡∏∞']],
    ['‡πÄ-‡∏≤‡∏∞', ['‡∏™‡∏£‡∏∞‡πÄ‡∏≠‡∏≤‡∏∞','‡∏™‡∏£‡∏∞ ‡πÄ‡∏≠‡∏≤‡∏∞','‡πÄ‡∏≠‡∏≤‡∏∞']],
    ['-‡∏≠',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏≠','‡∏™‡∏£‡∏∞ ‡∏≠‡∏≠','‡∏≠‡∏≠']],
    ['‡πÄ-‡∏≠',  ['‡∏™‡∏£‡∏∞‡πÄ‡∏≠‡∏≠','‡∏™‡∏£‡∏∞ ‡πÄ‡∏≠‡∏≠','‡πÄ‡∏≠‡∏≠']],
    ['‡πÄ-‡∏µ‡∏¢', ['‡∏™‡∏£‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢','‡∏™‡∏£‡∏∞ ‡πÄ‡∏≠‡∏µ‡∏¢','‡πÄ‡∏≠‡∏µ‡∏¢']],
    ['‡πÄ-‡∏∑‡∏≠', ['‡∏™‡∏£‡∏∞‡πÄ‡∏≠‡∏∑‡∏≠','‡∏™‡∏£‡∏∞ ‡πÄ‡∏≠‡∏∑‡∏≠','‡πÄ‡∏≠‡∏∑‡∏≠']],
    ['-‡∏±‡∏ß',  ['‡∏™‡∏£‡∏∞‡∏≠‡∏±‡∏ß','‡∏™‡∏£‡∏∞ ‡∏≠‡∏±‡∏ß','‡∏≠‡∏±‡∏ß']],
    ['‡πÉ-',   ['‡∏™‡∏£‡∏∞‡πÉ‡∏≠‡πÑ‡∏°‡πâ‡∏°‡πâ‡∏ß‡∏ô','‡∏™‡∏£‡∏∞ ‡πÉ‡∏≠‡πÑ‡∏°‡πâ‡∏°‡πâ‡∏ß‡∏ô','‡πÉ‡∏≠‡πÑ‡∏°‡πâ‡∏°‡πâ‡∏ß‡∏ô','‡πÑ‡∏°‡πâ‡∏°‡πâ‡∏ß‡∏ô']],
    ['‡πÑ-',   ['‡∏™‡∏£‡∏∞‡πÑ‡∏≠‡πÑ‡∏°‡πâ‡∏°‡∏•‡∏≤‡∏¢','‡∏™‡∏£‡∏∞ ‡πÑ‡∏≠‡πÑ‡∏°‡πâ‡∏°‡∏•‡∏≤‡∏¢','‡πÑ‡∏≠‡πÑ‡∏°‡πâ‡∏°‡∏•‡∏≤‡∏¢','‡πÑ‡∏°‡πâ‡∏°‡∏•‡∏≤‡∏¢']],
    ['-‡∏≥',   ['‡∏™‡∏£‡∏∞‡∏≠‡∏≥','‡∏™‡∏£‡∏∞ ‡∏≠‡∏≥','‡∏≠‡∏≥']],
    ['‡πÄ-‡∏≤',  ['‡∏™‡∏£‡∏∞‡πÄ‡∏≠‡∏≤','‡∏™‡∏£‡∏∞ ‡πÄ‡∏≠‡∏≤','‡πÄ‡∏≠‡∏≤']],
];

const ALL_SPEECH = [...CONSONANT_SPEECH, ...VOWEL_SPEECH];

const PLAYER_COLORS = ['#4361ee', '#e84393', '#00b894', '#f39c12'];
const PLAYER_NAMES_DEFAULT = ['‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1', '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 2', '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 3', '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 4'];
const GAME_POOL_SIZES = { consonants: 35, vowels: 24, mixed: 42 };

// ============================================================
// STATE
// ============================================================
let state = {
    playerCount: 2,
    mode: 'mixed',
    hintsOn: true,
    players: [],
    boards: [],
    gamePool: [],
    calledChars: [],
    currentChar: null,
    gameActive: false,
    winners: [],
    confettiId: null,
    pendingChar: null,
    pendingSelections: {},
};

// ============================================================
// AUDIO
// ============================================================
let audioCtx = null;
function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}
function playTone(freq, dur, vol = 0.2, type = 'sine') {
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}
function sfxCall() { playTone(587, 0.15, 0.2); setTimeout(() => playTone(784, 0.15, 0.2), 100); }
function sfxMark() { playTone(880, 0.12, 0.15); }
function sfxWrong() { playTone(200, 0.15, 0.15, 'square'); }
function sfxWin() { [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playTone(f, 0.2, 0.25), i * 140)); }

// ============================================================
// UTILITIES
// ============================================================
function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}
function isVowel(ch) { return VOWELS.includes(ch); }

// ============================================================
// TTS & RANDOMIZE
// ============================================================
function getCharSpokenName(char) {
    for (const [ch, keywords] of ALL_SPEECH) {
        if (ch === char) return keywords[1] || keywords[0];
    }
    return char;
}

function speakChar(char) {
    speechSynthesis.cancel();
    let text = getCharSpokenName(char);
    text = text.replace(/‡∏™‡∏£‡∏∞/g, '‡∏™‡∏∞‡∏´‡∏£‡∏∞');
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'th-TH';
    utter.rate = 0.9;
    speechSynthesis.speak(utter);
}

function randomizeChar() {
    if (!state.gameActive) return;
    ensureAudio();

    const remaining = state.gamePool.filter(ch => !state.calledChars.includes(ch));
    if (remaining.length === 0) {
        setVoiceStatus('‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'error');
        document.getElementById('random-btn').disabled = true;
        return;
    }

    const char = remaining[Math.floor(Math.random() * remaining.length)];
    state.pendingChar = char;

    // Show "?" while pending
    const charEl = document.getElementById('current-char');
    const display = document.getElementById('caller-display');
    charEl.textContent = '?';
    display.classList.remove('has-char');

    speakChar(char);

    document.getElementById('random-btn').disabled = true;
    document.getElementById('replay-btn').classList.remove('hidden');
    document.getElementById('reveal-btn').classList.remove('hidden');
    setVoiceStatus('‡∏Å‡∏î ‡πÄ‡∏â‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', '');
}

function replayChar() {
    if (state.pendingChar) speakChar(state.pendingChar);
}

function revealChar() {
    if (!state.pendingChar) return;
    speechSynthesis.cancel();
    const char = state.pendingChar;
    state.pendingChar = null;
    document.getElementById('reveal-btn').classList.add('hidden');
    document.getElementById('replay-btn').classList.add('hidden');
    callCharacter(char);

    // Validate pending selections
    const selections = { ...state.pendingSelections };
    state.pendingSelections = {};

    for (const pi in selections) {
        const { r, c } = selections[pi];
        const cell = state.boards[pi][r][c];
        const el = document.getElementById(`cell-${pi}-${r}-${c}`);
        if (cell.char === char) {
            confirmMark(parseInt(pi), r, c);
        } else {
            el.classList.remove('selected');
            el.classList.add('wrong');
            sfxWrong();
            setTimeout(() => el.classList.remove('wrong'), 350);
        }
    }

    // Re-enable randomize if pool not exhausted
    const remaining = state.gamePool.filter(ch => !state.calledChars.includes(ch));
    if (remaining.length > 0) {
        document.getElementById('random-btn').disabled = false;
        setVoiceStatus('‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', 'success');
    } else {
        document.getElementById('random-btn').disabled = true;
        setVoiceStatus('‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡πâ‡∏ß', '');
    }
}

function setVoiceStatus(text, type) {
    const el = document.getElementById('voice-status');
    el.textContent = text;
    el.className = 'voice-status' + (type ? ' ' + type : '');
}

// ============================================================
// CHARACTER CALLING
// ============================================================
function callCharacter(char) {
    if (!state.gameActive) return;
    if (state.calledChars.includes(char)) return;

    state.currentChar = char;
    state.calledChars.push(char);

    sfxCall();

    // Update display
    const display = document.getElementById('caller-display');
    const charEl = document.getElementById('current-char');
    charEl.textContent = char;
    display.classList.remove('pop', 'has-char');
    void display.offsetWidth;
    display.classList.add('pop', 'has-char');

    document.getElementById('draw-count').textContent = state.calledChars.length;
    renderCalledHistory();
    updateHints();
}

// ============================================================
// SETUP UI
// ============================================================
function initSetup() {
    const pcContainer = document.getElementById('player-count-btns');
    pcContainer.innerHTML = '';
    [2, 3, 4].forEach(n => {
        const btn = document.createElement('button');
        btn.textContent = n + ' ‡∏Ñ‡∏ô';
        btn.className = n === state.playerCount ? 'active' : '';
        btn.onclick = () => { state.playerCount = n; initSetup(); };
        pcContainer.appendChild(btn);
    });

    const nameContainer = document.getElementById('name-inputs');
    nameContainer.innerHTML = '';
    for (let i = 0; i < state.playerCount; i++) {
        const row = document.createElement('div');
        row.className = 'name-input-row';
        const dot = document.createElement('div');
        dot.className = 'color-dot';
        dot.style.background = PLAYER_COLORS[i];
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = PLAYER_NAMES_DEFAULT[i];
        input.id = 'name-' + i;
        if (state.players[i]) input.value = state.players[i];
        row.appendChild(dot);
        row.appendChild(input);
        nameContainer.appendChild(row);
    }

    const modeContainer = document.getElementById('mode-btns');
    modeContainer.innerHTML = '';
    [{ key: 'consonants', label: '‡∏û‡∏¢‡∏±‡∏ç‡∏ä‡∏ô‡∏∞' }, { key: 'vowels', label: '‡∏™‡∏£‡∏∞' }, { key: 'mixed', label: '‡∏ú‡∏™‡∏°' }].forEach(m => {
        const btn = document.createElement('button');
        btn.textContent = m.label;
        btn.className = m.key === state.mode ? 'active' : '';
        btn.onclick = () => { state.mode = m.key; initSetup(); };
        modeContainer.appendChild(btn);
    });
}

// ============================================================
// GAME SETUP
// ============================================================
function startGame() {
    ensureAudio();

    state.players = [];
    for (let i = 0; i < state.playerCount; i++) {
        const input = document.getElementById('name-' + i);
        state.players.push(input && input.value.trim() ? input.value.trim() : PLAYER_NAMES_DEFAULT[i]);
    }
    state.hintsOn = document.getElementById('hints-check').checked;

    // Build character pool
    let fullPool;
    if (state.mode === 'consonants') fullPool = [...CONSONANTS];
    else if (state.mode === 'vowels') fullPool = [...VOWELS];
    else fullPool = [...CONSONANTS, ...VOWELS];

    const poolSize = Math.min(GAME_POOL_SIZES[state.mode], fullPool.length);
    state.gamePool = shuffle(fullPool).slice(0, poolSize);
    state.calledChars = [];
    state.currentChar = null;
    state.pendingChar = null;
    state.pendingSelections = {};
    state.winners = [];
    state.gameActive = true;

    // Generate boards
    state.boards = [];
    for (let p = 0; p < state.playerCount; p++) {
        state.boards.push(generateBoard(state.gamePool));
    }

    renderGame();
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('win-overlay').classList.add('hidden');

    // Reset randomize/replay/reveal button states
    document.getElementById('random-btn').disabled = false;
    document.getElementById('replay-btn').classList.add('hidden');
    document.getElementById('reveal-btn').classList.add('hidden');
    setVoiceStatus('‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°', '');
}

function generateBoard(pool) {
    const picked = shuffle(pool).slice(0, 24);
    const board = [];
    let idx = 0;
    for (let r = 0; r < 5; r++) {
        const row = [];
        for (let c = 0; c < 5; c++) {
            if (r === 2 && c === 2) {
                row.push({ char: '‚≠ê', marked: true, free: true });
            } else {
                row.push({ char: picked[idx++], marked: false, free: false });
            }
        }
        board.push(row);
    }
    return board;
}

// ============================================================
// RENDERING
// ============================================================
function renderGame() {
    document.getElementById('total-count').textContent = state.gamePool.length;
    document.getElementById('draw-count').textContent = state.calledChars.length;
    document.getElementById('current-char').textContent = state.currentChar || '?';

    const display = document.getElementById('caller-display');
    if (state.currentChar) display.classList.add('has-char');
    else display.classList.remove('has-char');

    renderCalledHistory();
    renderBoards();
}

function renderCalledHistory() {
    const container = document.getElementById('called-history');
    container.innerHTML = '';
    state.calledChars.forEach(ch => {
        const chip = document.createElement('span');
        chip.className = 'called-chip ' + (isVowel(ch) ? 'vowel' : 'consonant');
        chip.textContent = ch;
        container.appendChild(chip);
    });
    container.scrollTop = container.scrollHeight;
}

function renderBoards() {
    const container = document.getElementById('boards-container');
    container.className = 'boards-container players-' + state.playerCount;
    container.innerHTML = '';

    state.boards.forEach((board, pi) => {
        const card = document.createElement('div');
        card.className = 'board-card p' + pi;

        const header = document.createElement('div');
        header.className = 'board-header';
        header.textContent = state.players[pi];
        card.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'board-grid';

        for (let r = 0; r < 5; r++) {
            for (let c = 0; c < 5; c++) {
                const cell = board[r][c];
                const el = document.createElement('div');
                el.className = 'cell';
                el.id = `cell-${pi}-${r}-${c}`;
                el.textContent = cell.char;

                if (cell.free) el.classList.add('free');
                if (cell.marked && !cell.free) el.classList.add('marked');
                if (!cell.free && !cell.marked) {
                    el.onclick = () => markCell(pi, r, c);
                }

                grid.appendChild(el);
            }
        }

        card.appendChild(grid);
        container.appendChild(card);
    });

    updateHints();
}

function updateHints() {
    if (!state.hintsOn) return;
    state.boards.forEach((board, pi) => {
        for (let r = 0; r < 5; r++) {
            for (let c = 0; c < 5; c++) {
                const cell = board[r][c];
                const el = document.getElementById(`cell-${pi}-${r}-${c}`);
                if (!el) continue;
                if (!cell.marked && !cell.free && state.calledChars.includes(cell.char)) {
                    el.classList.add('hint-pulse');
                } else {
                    el.classList.remove('hint-pulse');
                }
            }
        }
    });
}

// ============================================================
// MARKING & WIN
// ============================================================
function markCell(pi, r, c) {
    if (!state.gameActive) return;
    const cell = state.boards[pi][r][c];
    if (cell.marked || cell.free) return;

    // If a character is pending, allow tentative selection (one per player)
    if (state.pendingChar) {
        // Deselect previous selection for this player
        const prev = state.pendingSelections[pi];
        if (prev) {
            const prevEl = document.getElementById(`cell-${prev.pi}-${prev.r}-${prev.c}`);
            if (prevEl) prevEl.classList.remove('selected');
        }
        // Toggle: clicking same cell deselects
        if (prev && prev.r === r && prev.c === c) {
            delete state.pendingSelections[pi];
        } else {
            state.pendingSelections[pi] = { pi, r, c };
            const el = document.getElementById(`cell-${pi}-${r}-${c}`);
            el.classList.add('selected');
            sfxMark();
        }
        return;
    }

    // Normal marking for already-called characters
    if (!state.calledChars.includes(cell.char)) {
        sfxWrong();
        const el = document.getElementById(`cell-${pi}-${r}-${c}`);
        el.classList.add('wrong');
        setTimeout(() => el.classList.remove('wrong'), 350);
        return;
    }

    confirmMark(pi, r, c);
}

function confirmMark(pi, r, c) {
    const cell = state.boards[pi][r][c];
    cell.marked = true;
    sfxMark();

    const el = document.getElementById(`cell-${pi}-${r}-${c}`);
    el.classList.remove('selected', 'hint-pulse');
    el.classList.add('marked', 'mark-anim');
    el.onclick = null;
    setTimeout(() => el.classList.remove('mark-anim'), 400);

    const winLine = checkWin(pi);
    if (winLine && !state.winners.includes(pi)) {
        state.winners.push(pi);
        highlightWinLine(pi, winLine);
        setTimeout(() => showWin(pi), 500);
    }
}

function checkWin(pi) {
    const board = state.boards[pi];
    for (let r = 0; r < 5; r++) {
        if (board[r].every(cell => cell.marked)) return board[r].map((_, c) => [r, c]);
    }
    for (let c = 0; c < 5; c++) {
        if (board.every(row => row[c].marked)) return board.map((_, r) => [r, c]);
    }
    if ([0,1,2,3,4].every(i => board[i][i].marked)) return [0,1,2,3,4].map(i => [i, i]);
    if ([0,1,2,3,4].every(i => board[i][4-i].marked)) return [0,1,2,3,4].map(i => [i, 4-i]);
    return null;
}

function highlightWinLine(pi, line) {
    line.forEach(([r, c]) => {
        const el = document.getElementById(`cell-${pi}-${r}-${c}`);
        if (el) el.classList.add('win-glow');
    });
}

// ============================================================
// WIN / CONTINUE / RESET
// ============================================================
function showWin(pi) {
    sfxWin();
    state.gameActive = false;
    speechSynthesis.cancel();
    document.getElementById('winner-name').textContent = state.players[pi];
    document.getElementById('win-overlay').classList.remove('hidden');
    startConfetti();
}

function continueAfterWin() {
    stopConfetti();
    document.getElementById('win-overlay').classList.add('hidden');
    state.gameActive = true;
}

function resetGame() {
    stopConfetti();
    speechSynthesis.cancel();
    document.getElementById('win-overlay').classList.add('hidden');
    startGame();
}

function backToSetup() {
    stopConfetti();
    speechSynthesis.cancel();
    document.getElementById('win-overlay').classList.add('hidden');
    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
}

// ============================================================
// CONFETTI
// ============================================================
function startConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const colors = ['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#06b6d4'];
    const particles = Array.from({ length: 180 }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * -canvas.height,
        w: Math.random() * 10 + 5, h: Math.random() * 6 + 3,
        color: colors[Math.floor(Math.random() * colors.length)],
        speed: Math.random() * 3 + 2,
        angle: Math.random() * Math.PI * 2,
        spin: (Math.random() - 0.5) * 0.15,
        drift: (Math.random() - 0.5) * 1.5,
        opacity: Math.random() * 0.5 + 0.5
    }));
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
            ctx.save(); ctx.globalAlpha = p.opacity;
            ctx.translate(p.x, p.y); ctx.rotate(p.angle);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
            ctx.restore();
            p.y += p.speed; p.x += p.drift; p.angle += p.spin;
            if (p.y > canvas.height + 20) { p.y = -20; p.x = Math.random() * canvas.width; }
        });
        state.confettiId = requestAnimationFrame(draw);
    }
    draw();
}
function stopConfetti() {
    if (state.confettiId) { cancelAnimationFrame(state.confettiId); state.confettiId = null; }
    const canvas = document.getElementById('confetti-canvas');
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
}

// ============================================================
// INIT
// ============================================================
initSetup();
</script>
</body>
</html>
